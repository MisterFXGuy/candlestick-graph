<html>

    <title>Simple rates graph</title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://rawgithub.com/mrpoulin/oandajs/update/oanda.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>

    <script type="text/javascript">

        google.load("visualization", "1", {packages:["corechart"]});
        $('document').ready( function() {
                var granularityTable = (function() {

                    var my = {};
                    var granMap =  { 'S5'  : 5,  
                                     'S10' : 10 , 
                                     'S15' : 15, 
                                     'S30' : 30, 
                                     'M1'  : 60, 
                                     'M2'  : 120, 
                                     'M3'  : 180, 
                                     'M5'  : 300, 
                                     'M10' : 600, 
                                     'M15' : 900,
                                     'M30' : 1800, 
                                     'H1'  : 3600,
                                     'H2'  : 7200, 
                                     'H3'  : 10800, 
                                     'H4'  : 14400, 
                                     'H6'  : 21600, 
                                     'H8'  : 28800, 
                                     'H12' : 43200, 
                                     'D'   : 86400, 
                                     'W'   : 604800,
                                     'M'   : /*Depends on the month & year (for feb only). 0 for now.*/ 0,
                                    };

                    my.granularities = Object.keys(granMap);
                    my.granulatityToSeconds = function(gran) {
                        if(!granMap[gran])
                            return -1;

                        return granMap[gran];
                    }
                    return my;

                }());

                var candlestickChart = ( function(granTable) {
                        var my = {};

                        //"Private" variables
                        var granularity = 'M30';
                        var instrument = 'EUR_USD';
                        chart = new google.visualization.CandlestickChart(document.getElementById('chart'));

                        my.init = function(inst, gran) {
                            granularity = gran;
                            instrument = inst;
                        }

                        my.render = function render() {
                            var candleTime = new Date("2013-08-09T00:00:00Z");
                            //Get current rate:
                            OANDA.rate.history(instrument, { 'start' : candleTime.toISOString(), candleFormat : 'midpoint', granularity : granularity}, function(response) {
                                if(response.error) {
                                    console.log(response.error);
                                    return;
                                }
                                var data = new google.visualization.DataTable();
                                data.addColumn('datetime', 'Time');
                                data.addColumn('number', instrument);
                                data.addColumn('number', '2');
                                data.addColumn('number', '3');
                                data.addColumn('number', '4');

                                for(i = 0 ; i < response.candles.length; i++) {
                                    candle = response.candles[i];
                                    data.addRows([[new Date(candle.time), candle.lowMid, candle.closeMid, candle.openMid, candle.highMid]]);
                                }

                                var options = { 'title' : "Candlesticks", height : 600 };
                                chart.draw(data, options);
                            });

                            my.changeGranularity = function(newGran) {
                                chart.clearChart();
                                granularity = newGran;
                                my.render();
                            }

                            my.changeInstrument = function(newInst) {
                                chart.clearChart();
                                instrument = newInst;
                                my.render();
                            }
                        }
                        return my;

                }(granularityTable));
                
                //Will run chart with default values.
                google.setOnLoadCallback(candlestickChart.render);

                //Populate the granularity select box:
                for(var i = 0; i < granularityTable.granularities.length; i++) {
                    gran = granularityTable.granularities[i];
                    $('#granularitySelector').append($('<option>', { text : gran, value : gran }))
                    $('#granularitySelector').val('M30');
                }


                //Populate the instrument select box:
                OANDA.rate.instruments(['instrument'], function(response) {
                    for(var i = 0; i < response.instruments.length; i++) {
                        var instrument = response.instruments[i].instrument;
                        $('#instrumentSelector').append($('<option>', { value : instrument, text : instrument }));
                    }

                    //Make sure an instrument is set and everything is ready to go:
                    $('#instrumentSelector').val('EUR_USD');
                });
                
               //Clear the graph if the select box changes:
                $('#instrumentSelector').change( function() {
                    candlestickChart.changeInstrument($('#instrumentSelector').val());
                });

                $('#granularitySelector').change(function() {
                    candlestickChart.changeGranularity($('#granularitySelector').val());
                });


                
        });
    </script>

    <style>
        #chart {
            overflow-x:auto;
            overflow-y:hidden;
        }
    </style>

    <body>
        <form>
            <label for="instrumentSelector">Instrument Selector:</label>
            <select id="instrumentSelector"></select>
            <label for="granularitySelector">Granularity Selector:</label>
            <select id="granularitySelector"></select>
        <div id='chart'>
        </div>
    </body>

</html>

